#+title: looking-glass

looking-glass is an Emacs Lisp optics library inspired by Haskell's =lens=,
adapted to idiomatic Elisp data structures.

The runtime is profunctor-based for both unindexed and indexed optics.
Composed optics are represented as composed =rep=/=irep= functions, and public
operations evaluate those representations directly.

* Scope

- Composable optics values and operations.
- Lenses, prisms, traversals, indexed traversals, and composition.
- Basic optics for lists, cons cells, plists, hash tables, and vectors.
- String editing traversal via regex matches and capture groups.

Out of scope for this package:

- Domain-specific optics (for JSON, org trees, etc.).
- UI, modes, and interactive commands.

* Quick start

#+begin_src emacs-lisp
(require 'looking-glass)

;; Lens: update nested list element
(lg-over (lg-compose (lg-nth 1) (lg-nth 0))
         (lambda (x) (+ x 10))
         '((a b) (1 2 3)))
;; => ((a b) (11 2 3))

;; Traversal: rewrite all matches in a string
(lg-over (lg-regex "[0-9]+")
         (lambda (n) (format "<%s>" n))
         "x12y34")
;; => "x<12>y<34>"

;; Prism-style preview
(lg-preview (lg-just) nil)  ;; => nil
(lg-preview (lg-just) 42)   ;; => 42

;; Indexed traversal: index-aware updates
(lg-iover (lg-ieach-list)
          (lambda (i v) (if (= i 0) (upcase v) v))
          '("a" "b" "c"))
;; => ("A" "b" "c")
#+end_src

* Core API

- Constructors: =lg-lens=, =lg-ilens=, =lg-prism=, =lg-traversal=,
  =lg-itraversal=, =lg-filtered=, =lg-ifiltered=, =lg-wander=,
  =lg-iwander=, =lg-compose=.
- Getters: =lg-view=, =lg-preview=, =lg-to-list-of=, =lg-ito-list-of=.
- Updaters: =lg-set=, =lg-over=, =lg-iover=.
- Prism review: =lg-review=.
- Inspectors: =lg-kind=, =lg-capabilities=, =lg-can-p=.

* Running tests

#+begin_src sh
emacs -Q --batch -L . -L test -l test/looking-glass-test.el -f ert-run-tests-batch-and-exit
#+end_src

* Installation with use-package

** Emacs 29+ (built-in vc support)

#+begin_src emacs-lisp
(use-package looking-glass
  :vc (:url "https://github.com/fitzgibbon/looking-glass"
       :rev :newest)
  :demand t)
#+end_src

** straight.el

#+begin_src emacs-lisp
(use-package looking-glass
  :straight (looking-glass
             :type git
             :host github
             :repo "fitzgibbon/looking-glass")
  :demand t)
#+end_src

* JSON extension

This repo also includes =looking-glass-json.el= for JSON-specific optics:

- Boundary prisms: =lg-json-string=, =lg-json-string-alist=,
  =lg-json-string-plist=, =lg-json-string-hash=.
- Object/array optics: =lg-jkey=, =lg-jindex=, =lg-jvalues=,
  indexed variants =lg-ijkey=, =lg-ijindex=, =lg-ijvalues=.
- Path helper: =lg-jpath=.

Example:

#+begin_src emacs-lisp
(require 'looking-glass)
(require 'looking-glass-json)

(setq json "{\"user\":{\"name\":\"ada\",\"age\":20}}")

(lg-over (lg-compose (lg-json-string-alist)
                     (lg-jpath "user" "name"))
         #'upcase
         json)
;; => "{\"user\":{\"name\":\"ADA\",\"age\":20}}"
#+end_src
